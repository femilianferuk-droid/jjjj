import logging
import json
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Updater, CommandHandler, CallbackQueryHandler, 
    MessageHandler, Filters, ConversationHandler, 
    CallbackContext
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
ADMIN_ID = 7973988177  # –í–∞—à Telegram ID
# –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
BOT_TOKEN = ""  # –û—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º, –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–æ —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è

# –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
DATA_FILE = 'buttons_data.json'

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
BUTTON_NAME, BUTTON_URL, REMOVE_BUTTON, EDIT_BUTTON_ID, EDIT_BUTTON_NAME, EDIT_BUTTON_URL, WELCOME_MESSAGE = range(7)

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
def load_data():
    try:
        with open(DATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        default_data = {
            "buttons": [],
            "welcome_message": "üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç-–ø–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫!\n\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:"
        }
        save_data(default_data)
        return default_data

def save_data(data):
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def create_keyboard(buttons_data):
    if not buttons_data:
        return None
    
    keyboard = []
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ 2 –≤ —Ä—è–¥
    for i in range(0, len(buttons_data), 2):
        row = []
        for j in range(2):
            if i + j < len(buttons_data):
                button = buttons_data[i + j]
                row.append(InlineKeyboardButton(button['name'], url=button['url']))
        keyboard.append(row)
    
    return InlineKeyboardMarkup(keyboard)

# –ö–æ–º–∞–Ω–¥–∞ /start
def start(update: Update, context: CallbackContext):
    data = load_data()
    keyboard = create_keyboard(data['buttons'])
    update.message.reply_text(data['welcome_message'], reply_markup=keyboard)

# –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
def admin_panel(update: Update, context: CallbackContext):
    if update.effective_user.id != ADMIN_ID:
        update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏")
        return
    
    keyboard = [
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É", callback_data='add_button')],
        [InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É", callback_data='edit_button')],
        [InlineKeyboardButton("‚ùå –£–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫—É", callback_data='remove_button')],
        [InlineKeyboardButton("üìù –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ", callback_data='edit_welcome')],
        [InlineKeyboardButton("üìä –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏", callback_data='view_buttons')]
    ]
    
    update.message.reply_text("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:", reply_markup=InlineKeyboardMarkup(keyboard))

# –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–Ω–æ–ø–æ–∫
def button_callback(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    
    if query.from_user.id != ADMIN_ID:
        query.edit_message_text(text="‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return ConversationHandler.END
    
    if query.data == 'add_button':
        query.edit_message_text(text="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏:")
        return BUTTON_NAME
    elif query.data == 'view_buttons':
        data = load_data()
        if not data['buttons']:
            query.edit_message_text(text="üì≠ –°–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –ø—É—Å—Ç.")
        else:
            response = "üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫:\n\n"
            for i, button in enumerate(data['buttons'], 1):
                response += f"{i}. {button['name']}\n   üîó {button['url']}\n\n"
            query.edit_message_text(text=response)
        return ConversationHandler.END
    elif query.data == 'remove_button':
        data = load_data()
        if not data['buttons']:
            query.edit_message_text(text="üì≠ –°–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –ø—É—Å—Ç.")
            return ConversationHandler.END
        else:
            response = "‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏\n\n–í—ã–±–µ—Ä–∏—Ç–µ ID –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:\n\n"
            for button in data['buttons']:
                response += f"{button['id']}. {button['name']}\n"
            query.edit_message_text(text=response)
            return REMOVE_BUTTON
    elif query.data == 'edit_button':
        data = load_data()
        if not data['buttons']:
            query.edit_message_text(text="üì≠ –°–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –ø—É—Å—Ç.")
            return ConversationHandler.END
        else:
            response = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏\n\n–í—ã–±–µ—Ä–∏—Ç–µ ID –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:\n\n"
            for button in data['buttons']:
                response += f"{button['id']}. {button['name']}\n"
            query.edit_message_text(text=response)
            return EDIT_BUTTON_ID
    elif query.data == 'edit_welcome':
        data = load_data()
        query.edit_message_text(
            f"–¢–µ–∫—É—â–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:\n\n{data['welcome_message']}\n\n"
            f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:"
        )
        return WELCOME_MESSAGE
    
    return ConversationHandler.END

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
def add_button_name(update: Update, context: CallbackContext):
    if update.effective_user.id != ADMIN_ID:
        update.message.reply_text("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return ConversationHandler.END
    
    context.user_data['button_name'] = update.message.text
    update.message.reply_text("–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ URL –¥–ª—è –∫–Ω–æ–ø–∫–∏ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å http:// –∏–ª–∏ https://):")
    return BUTTON_URL

def add_button_url(update: Update, context: CallbackContext):
    if update.effective_user.id != ADMIN_ID:
        update.message.reply_text("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return ConversationHandler.END
    
    url = update.message.text
    if not url.startswith(('http://', 'https://')):
        update.message.reply_text("URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:")
        return BUTTON_URL
    
    button_data = load_data()
    new_button = {
        'id': len(button_data['buttons']) + 1,
        'name': context.user_data['button_name'],
        'url': url
    }
    button_data['buttons'].append(new_button)
    save_data(button_data)
    
    update.message.reply_text(f"‚úÖ –ö–Ω–æ–ø–∫–∞ '{context.user_data['button_name']}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!")
    return ConversationHandler.END

# –£–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
def remove_button(update: Update, context: CallbackContext):
    if update.effective_user.id != ADMIN_ID:
        update.message.reply_text("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return ConversationHandler.END
    
    try:
        button_id = int(update.message.text)
        data = load_data()
        
        button_to_remove = None
        for button in data['buttons']:
            if button['id'] == button_id:
                button_to_remove = button
                break
        
        if button_to_remove:
            data['buttons'].remove(button_to_remove)
            # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º ID
            for i, button in enumerate(data['buttons'], 1):
                button['id'] = i
            save_data(data)
            update.message.reply_text(f"‚úÖ –ö–Ω–æ–ø–∫–∞ '{button_to_remove['name']}' —É–¥–∞–ª–µ–Ω–∞!")
        else:
            update.message.reply_text("‚ùå –ö–Ω–æ–ø–∫–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
    
    except ValueError:
        update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID –∫–Ω–æ–ø–∫–∏.")
    
    return ConversationHandler.END

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
def edit_button_id(update: Update, context: CallbackContext):
    if update.effective_user.id != ADMIN_ID:
        update.message.reply_text("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return ConversationHandler.END
    
    try:
        button_id = int(update.message.text)
        data = load_data()
        
        button_to_edit = None
        for button in data['buttons']:
            if button['id'] == button_id:
                button_to_edit = button
                break
        
        if button_to_edit:
            context.user_data['edit_button_id'] = button_id
            context.user_data['edit_button'] = button_to_edit
            update.message.reply_text(
                f"–¢–µ–∫—É—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: {button_to_edit['name']}\n"
                f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ '-' —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):"
            )
            return EDIT_BUTTON_NAME
        else:
            update.message.reply_text("‚ùå –ö–Ω–æ–ø–∫–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
    
    except ValueError:
        update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID –∫–Ω–æ–ø–∫–∏.")
    
    return ConversationHandler.END

def edit_button_name(update: Update, context: CallbackContext):
    if update.effective_user.id != ADMIN_ID:
        update.message.reply_text("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return ConversationHandler.END
    
    new_name = update.message.text
    if new_name != '-':
        context.user_data['new_button_name'] = new_name
    else:
        context.user_data['new_button_name'] = context.user_data['edit_button']['name']
    
    update.message.reply_text(
        f"–¢–µ–∫—É—â–∏–π URL: {context.user_data['edit_button']['url']}\n"
        f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π URL (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ '-' —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):"
    )
    return EDIT_BUTTON_URL

def edit_button_url(update: Update, context: CallbackContext):
    if update.effective_user.id != ADMIN_ID:
        update.message.reply_text("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return ConversationHandler.END
    
    new_url = update.message.text
    button_id = context.user_data['edit_button_id']
    data = load_data()
    
    for button in data['buttons']:
        if button['id'] == button_id:
            if new_url != '-':
                if not new_url.startswith(('http://', 'https://')):
                    update.message.reply_text("‚ùå URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://")
                    return ConversationHandler.END
                button['url'] = new_url
            button['name'] = context.user_data['new_button_name']
            break
    
    save_data(data)
    update.message.reply_text("‚úÖ –ö–Ω–æ–ø–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!")
    return ConversationHandler.END

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
def edit_welcome(update: Update, context: CallbackContext):
    if update.effective_user.id != ADMIN_ID:
        update.message.reply_text("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return ConversationHandler.END
    
    data = load_data()
    data['welcome_message'] = update.message.text
    save_data(data)
    
    update.message.reply_text("‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!")
    return ConversationHandler.END

# –û—Ç–º–µ–Ω–∞
def cancel(update: Update, context: CallbackContext):
    update.message.reply_text('–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.')
    return ConversationHandler.END

def main():
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    import sys
    if len(sys.argv) > 1:
        token = sys.argv[1]
    else:
        # –ò–ª–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
        import os
        token = os.environ.get('BOT_TOKEN')
        if not token:
            print("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω —Ç–æ–∫–µ–Ω –±–æ—Ç–∞!")
            print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:")
            print("  1. python bot.py YOUR_BOT_TOKEN")
            print("  2. –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN")
            return
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    load_data()
    
    # –°–æ–∑–¥–∞–µ–º Updater —Å —Ç–æ–∫–µ–Ω–æ–º
    updater = Updater(token, use_context=True)
    dp = updater.dispatcher
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("admin", admin_panel))
    
    # –°–æ–∑–¥–∞–µ–º ConversationHandler –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(button_callback)],
        states={
            BUTTON_NAME: [MessageHandler(Filters.text & ~Filters.command, add_button_name)],
            BUTTON_URL: [MessageHandler(Filters.text & ~Filters.command, add_button_url)],
            REMOVE_BUTTON: [MessageHandler(Filters.text & ~Filters.command, remove_button)],
            EDIT_BUTTON_ID: [MessageHandler(Filters.text & ~Filters.command, edit_button_id)],
            EDIT_BUTTON_NAME: [MessageHandler(Filters.text & ~Filters.command, edit_button_name)],
            EDIT_BUTTON_URL: [MessageHandler(Filters.text & ~Filters.command, edit_button_url)],
            WELCOME_MESSAGE: [MessageHandler(Filters.text & ~Filters.command, edit_welcome)],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )
    
    dp.add_handler(conv_handler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    print(f"üëë –ê–¥–º–∏–Ω ID: {ADMIN_ID}")
    print("üëâ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã")
    print("üîß –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /admin –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏")
    print("ü§ñ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç...")
    
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
